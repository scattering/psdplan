<html>
<head>
    <title>Neutron Activation Calculator</title>

    <style type="text/css">
        body { font-size: 0.9em; }
        label { font-weight: inherit; }
        .hidden { overflow: hidden; }
        .colborder { margin-bottom: -100%; padding-bottom: 100%; }
        caption, td, th { padding-top: 0, padding-bottom: 0; }
        table { empty-cells: hide; }
        th { vertical-align: baseline; }
        tbody tr:nth-child(2n) th, tbody tr.even th,
        tbody tr:nth-child(2n) td, tbody tr.even td,
        ul li:nth-child(2n), ol li:nth-child(2n) { background: inherit; /* background: none repeat scroll 0 0 #F3F3F9; */ }
        .error { color: red; }
        div.inline { float:left; }
        .clearBoth { clear:both; }
    </style>


    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/themes/start/jquery-ui.css" type="text/css" rel="Stylesheet" />


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js" type="text/javascript"></script>
    <script src="/static/lib/ajaxCSRFfix.js" type="text/javascript"></script>


    <script type="text/javascript">
        // Parse environment variables "activation.html?cutoff=...&abundance=..."
        function getURLParameter(name) {
            return decodeURIComponent(
                (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
             );
        }
        CUTOFF = getURLParameter('cutoff');
        if (CUTOFF==='null') CUTOFF = 0.0001;
        DECAY = getURLParameter('decay');
        if (DECAY ==='null') DECAY = 0.0001;
        ABUNDANCE = getURLParameter('abundance');
        if (ABUNDANCE==='null') ABUNDANCE = "NIST";

        function format_value(v) {
            return (v<CUTOFF ? '---' : ''+v.toPrecision(4));
        }
        $(document).ready(function() {
            $("#id-activationForm").submit(function(event){
                event.preventDefault();
                $.ajax({
                    type:"POST",
                    url:"http://sparkle.ncnr.nist.gov:8000/cgibin/nact.py",
                    data: {sample: $('input:text[id=id_chemical_formula]').val(),
                        flux: $('input:text[id=id_flux]').val(),
                        mass: $('input:text[id=id_mass]').val(),
                        density: $('input:text[id=id_density]').val(),
                        thickness: $('input:text[id=id_thickness]').val(),
                        wavelength: $('input:text[id=id_wavelength]').val(),
                        exposure: $('input:text[id=id_time_on]').val(),
                        rest: [0,1,24,360,parseFloat($('input:text[id=id_time_off]').val())],
                        activity: DECAY,
                        //abundance: $('input:text[id=id_abundance]').val()
                        abundance: ABUNDANCE
                    },
                    success: function(ldata){
                        //console.log(ldata);
                        if (typeof(ldata)==="string") ldata=$.parseJSON(ldata);
                        if (!ldata.success) {
                           var keys = Object.keys(ldata.detail);
                           keys.sort();
                           var content = '<div class="result error"><hr />\n';
                           for (i = keys.length-1; i >= 0; i--) {
                               content += '<pre class="error">Error ' +keys[i]+': '+ldata.detail[keys[i]]+'</pre>\n';
                           }
                           content += '</div>\n';
                           $(content).prependTo('div[id=results]');
                           return;
                        }
                        var act = ldata.activation;
                        var sample = ldata.sample;
                        var scat = ldata.scattering;
                        // Drop coherent cross section from penetration depth calculation.
                        // An alternative formulation, based on total scattering b, would be
                        // penetration = 1/(1/scat.penetration - scat.xs.coh), which perhaps
                        // takes diffuse coherent scattering into account [Glinka 2011].
                        var penetration = 1 /(scat.xs.abs+scat.xs.incoh);
                        var transmission = 100*Math.exp(-sample.thickness/penetration);
                        //act.total.splice(0,0,"total activity","","",""); //for a final column
                        //act.activity.push(act.total);
                        var data={}
                        //construct headers
                        data.headers=["element","daughter","reaction","half life","0 hrs","1 hr", "24 hrs", "15 days", act.rest[4]+" hrs"]
                        data.rows=[]
                        for (var i=0; i < act.activity.length; i++){
                            var active = false;
                            for (var j=4; j < act.activity[i].length; j++){
                                active = active || (act.activity[i][j] >= CUTOFF);
                            }
                            if (active) data.rows.push(act.activity[i]);
                        }
                        var show_total = false;
                        for (var j=0; j < act.total.length; j++) show_total = show_total || (act.total[j] >= CUTOFF);

                        var content = '<div clas="result"><hr>\n';
                        content += '<h3>'+sample.mass+' g of '+sample.formula+' for '+act.exposure+' hrs at '+act.flux.toPrecision(3)+' n/cm<sup>2</sup>/s</h3>\n';
                        content += "<p>Source neutrons: "
                                + scat.neutron.wavelength.toFixed(3) + " &Aring;"
                                + " = "+scat.neutron.energy.toFixed(1) + " meV"
                                + " = "+scat.neutron.velocity.toFixed(0) + " m/s</p>";
                        content += '<table border=1>\n <tr>';
                        content += '<th colspan="2">1/e penetration depth (cm)</th>';
                        content += '<th colspan="2">Scattering length density (10<sup>-6</sup>/&Aring;<sup>3</sup>)</th>';
                        content += '<th colspan="2">Scattering cross section (1/cm)</th>';
                        content += '</tr>\n <tr>';
                        content += '<th>abs</th><td>'+(1/scat.xs.abs).toFixed(3)+'</td>';
                        content += '<th>real</th><td>'+scat.sld.real.toFixed(3)+'</td>';
                        content += '<th>coh</th><td>'+scat.xs.coh.toFixed(3)+'</td>';
                        content += '</tr>\n <tr>';
                        content += '<th>abs+incoh</th><td>'+(1/(scat.xs.incoh+scat.xs.abs)).toFixed(3)+'</td>';
                        content += '<th>imag</th><td>'+scat.sld.imag.toFixed(3)+'</td>';
                        content += '<th>abs</th><td>'+scat.xs.abs.toFixed(3)+'</td>';
                        content += '</tr>\n <tr>';
                        content += '<th>abs+incoh+coh</th><td>'+scat.penetration.toFixed(3)+'</td>';
                        content += '<th>incoh</th><td>'+scat.sld.incoh.toFixed(3)+'</td>';
                        content += '<th>incoh</th><td>'+scat.xs.incoh.toFixed(3)+'</td>';
                        content += '</tr>\n <tr>';
                        content += '</tr>\n</table>';
                        content += '<p>Transmission is '+transmission.toFixed(2)+'% for '+sample.thickness+' cm of sample (after absorption and incoherent scattering).</p>\n';
                        if (data.rows.length > 0 || show_total) {
                            //add headers to table
                            content += '<table border=1>\n';
                            content += ' <tr class="header"><th colspan="4" /><th colspan="5">Activity'+(CUTOFF>0?' above '+CUTOFF:'')+' (&mu;Ci)</th></tr>\n';
                            content += ' <tr class="header">';
                            for (var i in data.headers) {
                                content += '<th>' + data.headers[i] + '</th>';
                            }
                            content += '</tr>\n'
                            for (var i in data.rows) {
                                content += ' <tr id="' + i + '">';
                                for (var j=0; j <data.rows[i].length; j++){
                                    if (j>=4) {
                                        content += '<td>'+format_value(data.rows[i][j])+'</td>';
                                    } else {
                                        content += '<td>' + data.rows[i][j] + '</td>';
                                    }
                                }
                                content += '</tr>\n';
                            }
                            content += ' <tr class="header"><th colspan="4">total activity</th>';
                            for (var j=0; j < act.total.length; j++) {
                                content += '<td>'+format_value(act.total[j])+'</td>';
                            }
                            content += ' </tr>\n';
                            content += '</table>\n';
                       } else {
                            content += '<p>No activation above '+CUTOFF+' &mu;Ci</p>';
                       }
                        if (act.decay_time > 0) {
                            var timestr = '';
                            if (act.decay_time > 365.2524*24) timestr = (act.decay_time/365.2524/24).toPrecision(2)+' years';
                            else if (act.decay_time > 48) timestr = (act.decay_time/24).toPrecision(2)+' days';
                            else if (act.decay_time > 2) timestr = act.decay_time.toPrecision(2)+' hours';
                            else if (act.decay_time > 2/60.) timestr = (act.decay_time*60).toPrecision(2)+' minutes';
                            else timestr = (act.decay_time*3600).toPrecision(2)+' seconds';
                            content += '<p>Time to decay below '+(1000*act.decay_level).toPrecision(3)+' nCi is '+timestr+'.</p>\n';
                        }
                       content += '</div>\n';

                       $(content).prependTo('div[id=results]'); //add to the dom
                    }
                });
            });
        });
    </script>

    <!--<script type="text/javascript" src="/static/lib/activation.js"></script>-->


</head>
<body>
<?php
  include("/var/www/include/navigation.inc");
  include("/var/www/include/utility.inc");
?>

<div class="container">
   
    <div id="activation_form">

        <form  id="id-activationForm" class="blueForms" method="post" >
            <div style='display:none'><input type='hidden' name='csrfmiddlewaretoken' value='cgmJug2PAM5TlxMPTcM2Q3nFmFR24giG' /> </div>
            <div id="div_id_chemical_formula" class="control-group inline">
               <label for="id_chemical_formula" class="control-label requiredField">Chemical Formula</label>
               <div class="controls"><input id="id_chemical_formula" type="text" class="textinput textInput" name="chemical_formula" value="Co" 
                    title="Sample formula such as CaCO3(H2O)6, or with 13-C at 10%, CaC[12]0.9C[13]0.1O3+6H2O"
                    /> </div>
            </div>
            <div id="div_id_mass" class="control-group inline">
               <label for="id_mass" class="control-label">Mass (g)</label>
               <div class="controls"><input id="id_mass" type="text" class="textinput textInput" name="mass" value="1" 
                    title="Sample mass.  Activation scales linearly with mass." /></div>
            </div>
            <div id="div_id_density" class="control-group inline">
               <label for="id_density" class="control-label">Density (g/cm<sup>3</sup>)</label>
               <div class="controls"><input id="id_density" type="text" class="textinput textInput" name="density" value="1" 
                    title="Sample density for calculating absorption and scattering length density." /></div>
            </div>
            <div id="div_id_thickness" class="control-group inline">
               <label for="id_thickness" class="control-label">Thickness (cm)</label>
               <div class="controls"><input id="id_thickness" type="text" class="textinput textInput" name="thickness" value="1" 
                    title="Sample thickness for computing total scattering." /></div>
            </div>
            <br class="clearBoth" />
            <div id="div_id_wavelength" class="control-group inline">
               <label for="id_wavelength" class="control-label">Wavelength (&Aring;)</label>
               <div class="controls"><input id="id_wavelength" type="text" class="textinput textInput" name="wavelength" value="1 Ang" 
                    title="Neutron wavelength; add units (meV, m/s or Ang) to use energy, velocity or wavelength." /></div>
            </div>
            <div id="div_id_time_on" class="control-group inline">
               <label for="id_time_on" class="control-label">Time on beam (hrs)</label>
               <div class="controls"><input id="id_time_on" type="text" class="textinput textInput" name="time_on" value="10" 
                    title="Sample exposure time." /> </div>
            </div>
            <div id="div_id_time_off" class="control-group inline">
               <label for="id_time_off" class="control-label requiredField">Time off beam (hrs)</label>
               <div class="controls"><input id="id_time_off" type="text" class="textinput textInput" name="time_off" value="120" 
                    title="Time since sample was removed from the beam.  0, 1 hour, 1 day and 15 days are automatically calculated" /> </div>
            </div>
            <div id="div_id_flux" class="control-group inline">
               <label for="id_flux" class="control-label requiredField">Instrument flux (n/cm<sup>2</sup>/s)
 (see <a href="http://www-i.ncnr.nist.gov/beamline_operations/instrument_fluxes.html">instrument flux table</a>)
               </label>
               <div class="controls"><input id="id_flux" type="text" class="textinput textInput" name="flux" value="1e8" 
                    title="Thermal beam flux at sample" /> </div>
            </div>
            <br class="clearBoth" />
<!--
            <div id="div_id_abundance" class="control-group">
               <label for="id_abundance" class="control-label requiredField">Abundance (IAEA or NIST)</label>
               <div class="controls"><input id="id_abundance" type="text" class="textinput textInput" name="abundance" value="NIST" 
                    title="Isotopic abundance for activation calculation uses either IAEA Report 273: Handbook of Nuclear Activation Data, 1987, or NIST Isotopic Composition of the Elements, 2001; sld and absorption calculations use NIST abundance."
               /> </div>
            </div>
-->
            <div class="form-actions"><input type="submit" name="submit" value="Submit" class="btn btn-primary" id="submit-id-submit" /> </div>
        </form>

    </div>
    <p>
    This form estimates the expected levels of neutron activation for a sample.  If an element is used in the chemical formula instead of a
    a specific isotope, then natural abundance is assumed.  This form is offered for estimation purposes. NCNR does not keep records of 
    samples evaluated with this form.
    </p><p>
    Note that use of this form is not a substitute for consulting with a Health Physicist. All samples must be cleared by a NIST Health 
    Physics before removal from the NCNR.
    </p><p>
    Neutron scattering calculations are performed by the <a href="http://www.reflectometry.org/danse/docs/elements/api/nsf.html#periodictable.nsf.neutron_scattering">periodictable</a> package.
    </p>

    <div id="results"> </div>

</div> 
<hr>
<div class="footer">
  <div style="float:left;"><p>Paul Kienzle (<a href="mailto:paul.kienzle@nist.gov">paul.kienzle@nist.gov</a>)</p></div>
  <div style="float:right;"><p>
<?php lastmod(); ?>
  </p></div>
</div>
</body>
</html>
